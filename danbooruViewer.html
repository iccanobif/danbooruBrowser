<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>danbooru browser</title>
  <link href="danbooruViewer.css" rel="stylesheet">
</head>

<body>
  <div id="navigator">
    fdsafdsafsadfsd
  </div>
  <iframe id="danbooruIframe">
  </iframe>
  <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"> </script>
  <script>if (window.module) module = window.module;</script>
  <script>
    const http = require("http")
    const fs = require("fs")
    const path = require("path")
    const download = require("download")
    const { remote, ipcRenderer } = require('electron')
    const { getUrlList } = require("./getUrlList")

    const danbooruIframe = document.getElementById("danbooruIframe")
    const navigator = document.getElementById("navigator")

    let currentTag = null
    let pageList = null
    let indexOfPagesForCurrentTag = null

    function showError(err)
    {
      alert(err)
    }

    function openDanbooruPage(url)
    {
      danbooruIframe.src = url
    }

    function openTag(tag)
    {
      console.log("opening tag " + tag)
      currentTag = tag

      getUrlList(currentTag)
        .then(links =>
        {
          console.log("sto per cercare di aprire la pagina")
          pageList = links
          indexOfPagesForCurrentTag = 0
          if (pageList.length == 0)
          {
            showError("no posts for tag " + currentTag)
          }
          else
          {
            openDanbooruPage(pageList[0].url)
          }
        })
        .catch(exc =>
        {
          throw new Error(exc)
        })
    }

    function updateNavigator()
    {
      $("#navigator").html(indexOfPagesForCurrentTag + "/" + pageList.length)
    }

    document.addEventListener("keypress", (ev) =>
    {
      switch (ev.key)
      {
        case "a":
          if (indexOfPagesForCurrentTag == 0)
          {
            showError("no")
          }
          else
          {
            indexOfPagesForCurrentTag--
            updateNavigator()
            openDanbooruPage(pageList[indexOfPagesForCurrentTag].url)
            // TODO insert to blacklist
          }
          break
        case "d":
          if (indexOfPagesForCurrentTag >= pageList.length)
          {
            showError("no")
          }
          else
          {
            indexOfPagesForCurrentTag++
            updateNavigator()
            openDanbooruPage(pageList[indexOfPagesForCurrentTag].url)
            // TODO insert to blacklist
          }
          break
        case "e":
          // SAVE
          const fileUrl = danbooruIframe.contentDocument.getElementById("image").src
          const fileName = "d:/ero/" + path.posix.basename(fileUrl)

          const req = new XMLHttpRequest()
          req.open("GET", fileUrl)
          req.responseType = "arraybuffer"
          req.onload = (event) =>
          {
            if (req.response)
            {
              fs.writeFileSync(fileName,new Uint8Array(req.response))
              alert("saved!")
            }
            else
              showError("something went wrong")
          }
          req.send(null)

          break
        case "q":
          // TODO insert to blacklist
          break
        case "s":
          // scroll up
          window.scrollBy(0, 100)
          break
        case "w":
          // scroll down
          window.scrollBy(0, -100)
          break
      }
    })

    danbooruIframe.addEventListener("load", (ev) =>
    {
      // The value 20 is arbitrary, i just added some more pixels because i couldn't be arsed to figure out a better way
      $("#danbooruIframe").height(danbooruIframe.contentWindow.document.body.scrollHeight + 20)
    })

    openTag(new URL(window.location).searchParams.get("tag"))
  </script>
</body>

</html>