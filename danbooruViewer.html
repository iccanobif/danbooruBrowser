<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>danbooru browser</title>
  <link href="danbooruViewer.css" rel="stylesheet">
</head>

<body>
  <div id="navigator">
    fdsafdsafsadfsd
  </div>
  <iframe id="danbooruIframe">
  </iframe>
  <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"> </script>
  <script>if (window.module) module = window.module;</script>
  <script>
    const http = require("http")
    const fs = require("fs")
    const path = require("path")
    const download = require("download")
    const { remote, ipcRenderer } = require('electron')
    const { getUrlList } = require("./getUrlList")

    const danbooruIframe = document.getElementById("danbooruIframe")
    const navigator = document.getElementById("navigator")

    let currentTag = null
    let pageList = null
    let indexOfPagesForCurrentTag = null

    function showError(err)
    {
      alert(err)
    }

    function openDanbooruPage(url)
    {
      danbooruIframe.src = url
    }

    function openTag(tag)
    {
      console.log("opening tag " + tag)
      currentTag = tag

      getUrlList(currentTag)
        .then(links =>
        {
          console.log("sto per cercare di aprire la pagina")
          pageList = links
          indexOfPagesForCurrentTag = 0
          openDanbooruPage(pageList[0].url)
        })
        .catch(exc =>
        {
          throw new Error(exc)
        })
    }

    function updateNavigator()
    {
      $("#navigator").html(indexOfPagesForCurrentTag + "/" + pageList.length)
    }

    document.addEventListener("keypress", (ev) =>
    {
      switch (ev.key)
      {
        case "a":
          if (indexOfPagesForCurrentTag == 0)
          {
            showError("no")
          }
          else
          {
            indexOfPagesForCurrentTag--
            updateNavigator()
            openDanbooruPage(pageList[indexOfPagesForCurrentTag].url)
            // TODO insert to blacklist
          }
          break
        case "d":
          if (indexOfPagesForCurrentTag >= pageList.length)
          {
            showError("no")
          }
          else
          {
            indexOfPagesForCurrentTag++
            updateNavigator()
            openDanbooruPage(pageList[indexOfPagesForCurrentTag].url)
            // TODO insert to blacklist
          }
          break
        case "e":
          // TODO save
          const fileUrl = pageList[indexOfPagesForCurrentTag].fileUrl
          const fileName = "d:/ero/" + path.posix.basename(fileUrl)

          download(fileUrl).then(data =>
          {
            fs.writeFile(fileName, data, (err) =>
            {
              if (err) showError(err)
            })
            alert("saved!")
          }).catch((reason) =>
          {
            showError(reason)
          })
          const file = fs.createWriteStream(fileName)
          http.get(fileUrl, (response) =>
          {
            if (response.statusCode !== 200)
              showError("Error, statusCode: " + response.statusCode)

            response.pipe(file)
          })

          break
        case "q":
          // TODO insert to blacklist
          break
        case "s":
          // TODO scroll up
          break
        case "w":
          // TODO scroll down
          break
      }
    })

    window.addEventListener("resize", (ev) =>
    {
      $("#danbooruIframe").height($(window).height() - $("#navigator").height() - 8) // I don't know why there are those 8 pixels of error...
    })

    openTag(new URL(window.location).searchParams.get("tag"))
  </script>
</body>

</html>