<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>danbooru browser</title>
  <link href="danbooruViewer.css" rel="stylesheet">
</head>

<body>
  <div id="navigator">
    <div id="position"></div>
    <a href="index.html">HOME</a>
    <!-- TODO:
      current tag name
      is saved
      loading animation
    -->
  </div>
  <iframe id="danbooruIframe">
  </iframe>
  <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"> </script>
  <script>if (window.module) module = window.module;</script>
  <script>
    const http = require("http")
    const fs = require("fs")
    const path = require("path")
    const { remote, ipcRenderer } = require('electron')
    const { getUrlList } = require("./getUrlList")
    const blacklist = require("./blacklist")

    const danbooruIframe = document.getElementById("danbooruIframe")
    const navigator = document.getElementById("navigator")

    let currentTag = null
    let linkList = null
    let indexOfPagesForCurrentTag = null

    function showError(err)
    {
      alert(err)
    }

    function openDanbooruPage(url)
    {
      updateNavigator()
      danbooruIframe.src = url
    }

    async function openTag(tag)
    {
      console.log("opening tag " + tag)
      currentTag = tag

      const md5Blacklist = await blacklist.getBlacklist()

      getUrlList(currentTag, md5Blacklist)
        .then(links =>
        {
          console.log("sto per cercare di aprire la pagina")
          linkList = links
          indexOfPagesForCurrentTag = 0
          if (linkList.length == 0)
          {
            showError("no posts for tag " + currentTag)
          }
          else
          {
            openDanbooruPage(linkList[0])
          }
        })
        .catch(exc =>
        {
          throw new Error(exc)
        })
    }

    function updateNavigator()
    {
      $("#position").html(indexOfPagesForCurrentTag + 1 + "/" + linkList.length + " " + currentTag)
    }

    function addCurrentImageToBlacklist()
    {
      const md5 = danbooruIframe.contentDocument.getElementById("image-container").attributes["data-md5"].value
      blacklist.addToBlacklist(md5)
    }

    document.addEventListener("keypress", (ev) =>
    {
      switch (ev.key)
      {
        case "a":
          if (indexOfPagesForCurrentTag == 0)
          {
            showError("no")
          }
          else
          {
            addCurrentImageToBlacklist()
            indexOfPagesForCurrentTag--
            openDanbooruPage(linkList[indexOfPagesForCurrentTag])
          }
          break
        case "d":
          if (indexOfPagesForCurrentTag >= linkList.length)
          {
            showError("no")
          }
          else
          {
            addCurrentImageToBlacklist()
            indexOfPagesForCurrentTag++
            openDanbooruPage(linkList[indexOfPagesForCurrentTag])
          }
          break
        case "e":
          // SAVE
          const fileUrl = danbooruIframe.contentDocument.getElementById("image").src
          const fileName = "d:/ero/" + path.posix.basename(fileUrl)

          const req = new XMLHttpRequest()
          req.open("GET", fileUrl)
          req.responseType = "arraybuffer"
          req.onload = (event) =>
          {
            if (req.response)
            {
              // TODO if the file already exists, alert and don't save
              try
              {
                fs.writeFileSync(fileName, new Uint8Array(req.response), { flag: "wx" })
                alert("saved!")
              }
              catch (exc)
              {
                if (exc.code == "EEXIST")
                  alert("file already exists...")
                else
                  throw exc
              }
            }
            else
              showError("something went wrong")
          }
          req.send(null)

          break
        case "s":
          // scroll up
          window.scrollBy(0, 100)
          break
        case "w":
          // scroll down
          window.scrollBy(0, -100)
          break
      }
    })

    danbooruIframe.addEventListener("load", (ev) =>
    {
      // The value 20 is arbitrary, i just added some more pixels because i couldn't be arsed to figure out a better way
      $("#danbooruIframe").height(danbooruIframe.contentWindow.document.body.scrollHeight + 20)
    })

    openTag(new URL(window.location).searchParams.get("tag"))
  </script>
</body>

</html>